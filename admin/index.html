<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donaro Admin Panel</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        
        .header {
            background-color: #6C63FF;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .header-controls {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: white;
            color: #6C63FF;
        }
        
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
        }
        
        .sidebar ul {
            list-style: none;
        }
        
        .sidebar li {
            padding: 1rem 2rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .sidebar li:hover, .sidebar li.active {
            background-color: #34495e;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #6C63FF;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .pending-donations {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .pending-donations h2 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            color: #6C63FF;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }
        
        .donation-item {
            display: flex;
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
        }
        
        .donation-item:last-child {
            border-bottom: none;
        }
        
        .donation-photo {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            background-color: #eee;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .donation-details {
            flex: 1;
        }
        
        .donation-details h3 {
            margin-bottom: 0.5rem;
        }
        
        .donation-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .donation-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .btn-approve {
            background-color: #10B981;
            color: white;
        }
        
        .btn-reject {
            background-color: #EF4444;
            color: white;
        }
        
        .btn-view {
            background-color: #6C63FF;
            color: white;
        }
        
        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #F59E0B;
            color: white;
        }
        
        .status-approved {
            background-color: #10B981;
            color: white;
        }
        
        .status-rejected {
            background-color: #EF4444;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6C63FF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .error-message {
            color: #EF4444;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Donation Admin Panel</h1>
        <div class="header-controls" id="header-controls" style="display: none;">
            <button class="btn btn-primary" onclick="refreshData()">Refresh Data</button>
            <button class="btn btn-primary" onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar" id="sidebar" style="display: none;">
            <ul>
                <li class="active" onclick="loadDashboard()">Dashboard</li>
                <li onclick="loadPendingDonations()">Pending Donations</li>
                <li onclick="loadApprovedDonations()">Approved Donations</li>
                <li onclick="loadRejectedDonations()">Rejected Donations</li>
                <li onclick="loadPendingWithdrawals()">Pending Withdrawals</li>
                <li>Users</li>
                <li>Reports</li>
                <li>Settings</li>
            </ul>
        </div>
        
        <div class="main-content" id="main-content">
            <!-- Login Form -->
            <div class="login-container" id="login-container">
                <h2>Admin Login</h2>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
                <div id="login-error" class="error-message"></div>
                
                <!-- Predefined Admin Credentials -->
                <div style="margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 8px; border: 1px solid #6C63FF;">
                    <h3 style="color: #6C63FF; margin-top: 0;">Predefined Admin Credentials</h3>
                    <p style="margin: 5px 0;"><strong>Email:</strong> admin@donaro.com</p>
                    <p style="margin: 5px 0;"><strong>Password:</strong> admin123</p>
                    <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">
                        Use these credentials to access the admin panel for managing donations and users.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('admin_token');
        let socket = null;
        
        // Check if already logged in
        if (authToken) {
            showAdminPanel();
            loadDashboard();
            initializeSocket();
        }
        
        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
                console.log('Connected to Socket.IO server');
                // Join admin room for real-time updates
                socket.emit('joinAdminRoom');
            });
            
            // Listen for real-time donation updates
            socket.on('donationCreated', (donation) => {
                console.log('New donation created:', donation);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
            
            socket.on('donationStatusUpdated', (donation) => {
                console.log('Donation status updated:', donation);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
            
            // Listen for real-time withdrawal updates
            socket.on('withdrawalCreated', (withdrawal) => {
                console.log('New withdrawal created:', withdrawal);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
            
            socket.on('withdrawalStatusUpdated', (withdrawal) => {
                console.log('Withdrawal status updated:', withdrawal);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
        }
        
        // Authentication functions
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password, isAdmin: true }),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Login failed');
                }
                
                const data = await response.json();
                
                // Check if user is admin
                if (!data.isAdmin) {
                    throw new Error('Access denied. Admin privileges required.');
                }
                
                authToken = data.token;
                localStorage.setItem('admin_token', authToken);
                
                showAdminPanel();
                loadDashboard();
                initializeSocket();
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }
        
        function logout() {
            authToken = null;
            localStorage.removeItem('admin_token');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            showLoginForm();
        }
        
        function showAdminPanel() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('header-controls').style.display = 'flex';
        }
        
        function showLoginForm() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('header-controls').style.display = 'none';
            document.getElementById('main-content').innerHTML = `
                <div class="login-container" id="login-container">
                    <h2>Admin Login</h2>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
                    <div id="login-error" class="error-message"></div>
                </div>
            `;
        }
        
        // API functions
        async function apiRequest(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                },
            };
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    logout();
                    throw new Error('Unauthorized');
                }
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }
            
            return await response.json();
        }
        
        // UI Functions
        function showLoading() {
            document.getElementById('main-content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading data...</p>
                </div>
            `;
        }
        
        async function loadDashboard() {
            showLoading();
            
            try {
                // Fetch actual stats
                const pendingDonations = await apiRequest('/donations/status/pending');
                const pendingWithdrawals = await apiRequest('/withdrawals/status/pending');
                // For now, we'll simulate with mock data for other stats
                const totalDonations = pendingDonations.length + 10; // Mock total
                const pendingCount = pendingDonations.length;
                const pendingWithdrawalsCount = pendingWithdrawals.length;
                const totalCredits = 5000; // Mock total credits
                
                document.getElementById('main-content').innerHTML = `
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3>Total Donations</h3>
                            <div class="value">${totalDonations}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Approval</h3>
                            <div class="value">${pendingCount}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Withdrawals</h3>
                            <div class="value">${pendingWithdrawalsCount}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Credits</h3>
                            <div class="value">${totalCredits}</div>
                        </div>
                    </div>
                    
                    <div class="pending-donations">
                        <h2>
                            Pending Donations
                            <button class="refresh-btn" onclick="loadPendingDonations()">
                                <i>↻</i> Refresh
                            </button>
                        </h2>
                        <div id="pending-donations-list">
                            ${renderDonationList(pendingDonations)}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('main-content').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading dashboard: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadPendingDonations() {
            showLoading();
            
            try {
                const donations = await apiRequest('/donations/status/pending');
                document.getElementById('main-content').innerHTML = `
                    <div class="pending-donations">
                        <h2>
                            Pending Donations
                            <button class="refresh-btn" onclick="loadPendingDonations()">
                                <i>↻</i> Refresh
                            </button>
                        </h2>
                        <div id="pending-donations-list">
                            ${donations.length > 0 ? renderDonationList(donations) : `
                                <div class="empty-state">
                                    <p>No pending donations</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('main-content').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading pending donations: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadApprovedDonations() {
            showLoading();
            
            try {
                const donations = await apiRequest('/donations/status/approved');
                document.getElementById('main-content').innerHTML = `
                    <div class="pending-donations">
                        <h2>
                            Approved Donations
                            <button class="refresh-btn" onclick="loadApprovedDonations()">
                                <i>↻</i> Refresh
                            </button>
                        </h2>
                        <div id="approved-donations-list">
                            ${donations.length > 0 ? renderDonationList(donations) : `
                                <div class="empty-state">
                                    <p>No approved donations</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('main-content').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading approved donations: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadRejectedDonations() {
            showLoading();
            
            try {
                const donations = await apiRequest('/donations/status/rejected');
                document.getElementById('main-content').innerHTML = `
                    <div class="pending-donations">
                        <h2>
                            Rejected Donations
                            <button class="refresh-btn" onclick="loadRejectedDonations()">
                                <i>↻</i> Refresh
                            </button>
                        </h2>
                        <div id="rejected-donations-list">
                            ${donations.length > 0 ? renderDonationList(donations) : `
                                <div class="empty-state">
                                    <p>No rejected donations</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('main-content').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading rejected donations: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadPendingWithdrawals() {
            showLoading();
            
            try {
                const withdrawals = await apiRequest('/withdrawals/status/pending');
                document.getElementById('main-content').innerHTML = `
                    <div class="pending-donations">
                        <h2>
                            Pending Withdrawals
                            <button class="refresh-btn" onclick="loadPendingWithdrawals()">
                                <i>↻</i> Refresh
                            </button>
                        </h2>
                        <div id="pending-withdrawals-list">
                            ${withdrawals.length > 0 ? renderWithdrawalList(withdrawals) : `
                                <div class="empty-state">
                                    <p>No pending withdrawals</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('main-content').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading pending withdrawals: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderDonationList(donations) {
            if (donations.length === 0) {
                return `
                    <div class="empty-state">
                        <p>No donations found</p>
                    </div>
                `;
            }
            
            return donations.map(donation => `
                <div class="donation-item" data-id="${donation.id}">
                    <div class="donation-photo">
                        Donation<br/>Photo
                    </div>
                    <div class="donation-details">
                        <h3>${donation.title}</h3>
                        <div class="donation-meta">
                            <span>User: ${donation.user?.name || 'Unknown'}</span>
                            <span>Date: ${donation.date}</span>
                            <span>Location: ${donation.location}</span>
                        </div>
                        <p>${donation.description}</p>
                        <span class="status-badge status-${donation.status}">${donation.status}</span>
                        <div class="donation-actions">
                            ${donation.status === 'pending' ? `
                                <button class="btn-action btn-approve" onclick="approveDonation('${donation.id}')">Approve</button>
                                <button class="btn-action btn-reject" onclick="rejectDonation('${donation.id}')">Reject</button>
                            ` : ''}
                            <button class="btn-action btn-view" onclick="viewDonationDetails('${donation.id}')">View Details</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderWithdrawalList(withdrawals) {
            if (withdrawals.length === 0) {
                return `
                    <div class="empty-state">
                        <p>No withdrawals found</p>
                    </div>
                `;
            }
            
            return withdrawals.map(withdrawal => `
                <div class="donation-item" data-id="${withdrawal.id}">
                    <div class="donation-details">
                        <h3>Withdrawal Request</h3>
                        <div class="donation-meta">
                            <span>User: ${withdrawal.user?.name || 'Unknown'}</span>
                            <span>Date: ${withdrawal.date}</span>
                            <span>Amount: ${withdrawal.amount} credits</span>
                        </div>
                        <span class="status-badge status-${withdrawal.status}">${withdrawal.status}</span>
                        <div class="donation-actions">
                            ${withdrawal.status === 'pending' ? `
                                <button class="btn-action btn-approve" onclick="processWithdrawal('${withdrawal.id}')">Process</button>
                                <button class="btn-action btn-reject" onclick="rejectWithdrawal('${withdrawal.id}')">Reject</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function approveDonation(donationId) {
            if (confirm('Are you sure you want to approve this donation?')) {
                try {
                    await apiRequest(`/donations/${donationId}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'approved' }),
                    });
                    
                    refreshCurrentView();
                    alert('Donation approved successfully!');
                } catch (error) {
                    alert(`Error approving donation: ${error.message}`);
                }
            }
        }
        
        async function rejectDonation(donationId) {
            if (confirm('Are you sure you want to reject this donation?')) {
                const reason = prompt('Please provide a reason for rejection:');
                if (reason) {
                    try {
                        await apiRequest(`/donations/${donationId}/status`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'rejected' }),
                        });
                        
                        refreshCurrentView();
                        alert('Donation rejected successfully!');
                    } catch (error) {
                        alert(`Error rejecting donation: ${error.message}`);
                    }
                }
            }
        }
        
        async function processWithdrawal(withdrawalId) {
            if (confirm('Are you sure you want to process this withdrawal?')) {
                try {
                    await apiRequest(`/withdrawals/${withdrawalId}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'processed' }),
                    });
                    
                    refreshCurrentView();
                    alert('Withdrawal processed successfully!');
                } catch (error) {
                    alert(`Error processing withdrawal: ${error.message}`);
                }
            }
        }
        
        async function rejectWithdrawal(withdrawalId) {
            if (confirm('Are you sure you want to reject this withdrawal?')) {
                const reason = prompt('Please provide a reason for rejection:');
                if (reason) {
                    try {
                        await apiRequest(`/withdrawals/${withdrawalId}/status`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'rejected' }),
                        });
                        
                        refreshCurrentView();
                        alert('Withdrawal rejected successfully!');
                    } catch (error) {
                        alert(`Error rejecting withdrawal: ${error.message}`);
                    }
                }
            }
        }
        
        function viewDonationDetails(donationId) {
            // Redirect to donation details page
            window.location.href = `donation-details.html?id=${donationId}`;
        }
        
        function refreshData() {
            refreshCurrentView();
        }
        
        function refreshCurrentView() {
            const activeItem = document.querySelector('.sidebar li.active');
            if (activeItem) {
                const text = activeItem.textContent.trim();
                switch (text) {
                    case 'Dashboard':
                        loadDashboard();
                        break;
                    case 'Pending Donations':
                        loadPendingDonations();
                        break;
                    case 'Approved Donations':
                        loadApprovedDonations();
                        break;
                    case 'Rejected Donations':
                        loadRejectedDonations();
                        break;
                    case 'Pending Withdrawals':
                        loadPendingWithdrawals();
                        break;
                }
            }
        }
        
        // Initialize sidebar navigation
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarItems = document.querySelectorAll('.sidebar li');
            sidebarItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all items
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                });
            });
        });
    </script>
</body>
</html>