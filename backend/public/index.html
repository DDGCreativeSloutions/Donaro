<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donaro Admin Panel</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #6C63FF 0%, #4a44c5 100%);
            color: white;
            padding: 1rem 1rem;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .header-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background-color: white;
            color: #6C63FF;
        }
        
        .btn-primary:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #1a2530 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 3px 0 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 100;
            position: fixed;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
        
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar li {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 1rem;
        }
        
        .sidebar li:hover, .sidebar li.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #6C63FF;
            padding-left: calc(1.5rem - 4px);
        }
        
        .sidebar li i {
            margin-right: 12px;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 1.5rem;
            background-color: #f8f9fa;
            margin-left: 260px;
            transition: all 0.3s ease;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #6C63FF;
        }
        
        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .pending-donations {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .pending-donations h2 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 1.3rem;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            color: #6C63FF;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: rgba(108, 99, 255, 0.1);
        }
        
        .donation-item {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
        }
        
        .donation-item:last-child {
            border-bottom: none;
        }
        
        .donation-photo {
            width: 100%;
            height: 150px;
            border-radius: 10px;
            background-color: #eee;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .donation-details {
            flex: 1;
        }
        
        .donation-details h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .donation-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #666;
        }
        
        .donation-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-action {
            padding: 0.5rem 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            flex: 1;
            min-width: 80px;
        }
        
        .btn-approve {
            background-color: #10B981;
            color: white;
        }
        
        .btn-reject {
            background-color: #EF4444;
            color: white;
        }
        
        .btn-view {
            background-color: #6C63FF;
            color: white;
        }
        
        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-pending {
            background-color: #F59E0B;
            color: white;
        }
        
        .status-approved {
            background-color: #10B981;
            color: white;
        }
        
        .status-rejected {
            background-color: #EF4444;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6C63FF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .users-table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 1rem;
            overflow-x: auto;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .users-table th {
            background-color: #6C63FF;
            color: white;
            text-align: left;
            padding: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .users-table tr:last-child td {
            border-bottom: none;
        }
        
        .users-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .login-container {
            max-width: 90%;
            width: 400px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .error-message {
            color: #EF4444;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        /* Settings Styles */
        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .settings-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .settings-card h3 {
            margin-bottom: 1.2rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }
        
        .settings-card h3 i {
            color: #6C63FF;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 1.2rem;
        }
        
        .user-detail-row {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f5f5f5;
            flex-wrap: wrap;
        }
        
        .user-detail-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .user-detail-row label {
            font-weight: 600;
            color: #6C63FF;
            width: 140px;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        
        .user-detail-row span {
            flex: 1;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.2rem;
            flex-wrap: wrap;
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #333;
            color: white;
            padding: 1rem 1.2rem;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            font-size: 0.9rem;
            max-width: 90%;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: #10B981;
        }
        
        .toast.error {
            background: #EF4444;
        }
        
        /* Mobile Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .stats-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 0.8rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-card h3 {
                font-size: 0.9rem;
            }
            
            .stat-card .value {
                font-size: 1.3rem;
            }
            
            .pending-donations {
                padding: 1.2rem;
            }
            
            .pending-donations h2 {
                font-size: 1.2rem;
            }
            
            .donation-item {
                padding: 0.8rem 0;
            }
            
            .donation-photo {
                height: 120px;
                font-size: 0.8rem;
            }
            
            .donation-details h3 {
                font-size: 1rem;
            }
            
            .donation-meta {
                gap: 0.6rem;
                font-size: 0.8rem;
            }
            
            .btn-action {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
                min-width: 70px;
            }
            
            .status-badge {
                font-size: 0.7rem;
            }
            
            .settings-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .settings-card {
                padding: 1.2rem;
            }
            
            .user-detail-row label {
                width: 120px;
                font-size: 0.85rem;
            }
            
            .user-detail-row span {
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 576px) {
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .donation-meta {
                flex-direction: column;
                gap: 0.3rem;
            }
            
            .donation-actions {
                flex-direction: column;
            }
            
            .btn-action {
                width: 100%;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-header h2 {
                font-size: 1.1rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .user-detail-row {
                flex-direction: column;
                gap: 0.3rem;
            }
            
            .user-detail-row label {
                width: 100%;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .toast {
                right: 10px;
                left: 10px;
                top: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <h1>Donation Admin Panel</h1>
        <div class="header-controls" id="header-controls" style="display: none;">
            <button class="btn btn-primary" onclick="refreshData()"><i class="fas fa-sync-alt"></i></button>
            <button class="btn btn-primary" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>
    
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <div class="container">
        <div class="sidebar" id="sidebar" style="display: none;">
            <ul>
                <li class="active" onclick="loadDashboard()"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li onclick="loadPendingDonations()"><i class="fas fa-hourglass-start"></i> Pending Donations</li>
                <li onclick="loadApprovedDonations()"><i class="fas fa-check-circle"></i> Approved Donations</li>
                <li onclick="loadRejectedDonations()"><i class="fas fa-times-circle"></i> Rejected Donations</li>
                <li onclick="loadPendingWithdrawals()"><i class="fas fa-money-bill-wave"></i> Pending Withdrawals</li>
                <li onclick="loadUsers()"><i class="fas fa-users"></i> Users</li>
                <li onclick="loadReports()"><i class="fas fa-chart-bar"></i> Reports</li>
                <li onclick="loadSettings()"><i class="fas fa-cog"></i> Settings</li>
            </ul>
        </div>
        
        <div class="main-content" id="main-content">
            <!-- Login Form -->
            <div class="login-container" id="login-container">
                <h2 style="text-align: center; margin-bottom: 1.5rem;">Admin Login</h2>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
                <div id="login-error" class="error-message"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('admin_token');
        let socket = null;
        
        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const headerControls = document.getElementById('header-controls');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                });
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
            }
            
            // Initialize sidebar navigation
            const sidebarItems = document.querySelectorAll('.sidebar li');
            sidebarItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all items
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Close sidebar on mobile after selection
                    if (window.innerWidth <= 992) {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                    }
                });
            });
        });
        
        // Check if already logged in
        if (authToken) {
            showAdminPanel();
            loadDashboard();
            initializeSocket();
        }
        
        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
                console.log('Connected to Socket.IO server');
                // Join admin room for real-time updates
                socket.emit('joinAdminRoom');
            });
            
            // Listen for real-time donation updates
            socket.on('donationCreated', (donation) => {
                console.log('New donation created:', donation);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
            
            socket.on('donationStatusUpdated', (donation) => {
                console.log('Donation status updated:', donation);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
            
            // Listen for real-time withdrawal updates
            socket.on('withdrawalCreated', (withdrawal) => {
                console.log('New withdrawal created:', withdrawal);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
            
            socket.on('withdrawalStatusUpdated', (withdrawal) => {
                console.log('Withdrawal status updated:', withdrawal);
                // Refresh current view if on relevant page
                refreshCurrentView();
            });
        }
        
        // Authentication functions
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            try {
                const response = await fetch(API_BASE_URL + '/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password, isAdmin: true }),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Login failed');
                }
                
                const data = await response.json();
                
                // Check if user is admin
                if (!data.isAdmin) {
                    throw new Error('Access denied. Admin privileges required.');
                }
                
                authToken = data.token;
                localStorage.setItem('admin_token', authToken);
                
                showAdminPanel();
                loadDashboard();
                initializeSocket();
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }
        
        function logout() {
            authToken = null;
            localStorage.removeItem('admin_token');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            showLoginForm();
        }
        
        function showAdminPanel() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('header-controls').style.display = 'flex';
            
            // Show menu toggle on mobile
            const menuToggle = document.getElementById('menu-toggle');
            if (menuToggle) {
                menuToggle.style.display = 'block';
            }
        }
        
        function showLoginForm() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('header-controls').style.display = 'none';
            document.getElementById('main-content').innerHTML = 
                '<div class="login-container" id="login-container">' +
                    '<h2 style="text-align: center; margin-bottom: 1.5rem;">Admin Login</h2>' +
                    '<div class="form-group">' +
                        '<label for="email">Email</label>' +
                        '<input type="email" id="email" placeholder="Enter your email">' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label for="password">Password</label>' +
                        '<input type="password" id="password" placeholder="Enter your password">' +
                    '</div>' +
                    '<button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>' +
                    '<div id="login-error" class="error-message"></div>' +
                '</div>';
            
            // Hide menu toggle on login screen
            const menuToggle = document.getElementById('menu-toggle');
            if (menuToggle) {
                menuToggle.style.display = 'none';
            }
        }
        
        // API functions
        async function apiRequest(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': 'Bearer ' + authToken }),
                },
            };
            
            const response = await fetch(API_BASE_URL + endpoint, {
                ...defaultOptions,
                ...options,
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    logout();
                    throw new Error('Unauthorized');
                }
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }
            
            return await response.json();
        }
        
        // UI Functions
        function showLoading() {
            document.getElementById('main-content').innerHTML = 
                '<div class="loading">' +
                    '<div class="loading-spinner"></div>' +
                    '<p>Loading data...</p>' +
                '</div>';
        }
        
        async function loadDashboard() {
            showLoading();
            
            try {
                // Fetch actual stats
                const pendingDonations = await apiRequest('/donations/status/pending');
                const pendingWithdrawals = await apiRequest('/withdrawals/status/pending');
                // For now, we'll simulate with mock data for other stats
                const totalDonations = pendingDonations.length + 10; // Mock total
                const pendingCount = pendingDonations.length;
                const pendingWithdrawalsCount = pendingWithdrawals.length;
                const totalCredits = 5000; // Mock total credits
                
                document.getElementById('main-content').innerHTML = 
                    '<div class="stats-container">' +
                        '<div class="stat-card">' +
                            '<h3>Total Donations</h3>' +
                            '<div class="value">' + totalDonations + '</div>' +
                        '</div>' +
                        '<div class="stat-card">' +
                            '<h3>Pending Approval</h3>' +
                            '<div class="value">' + pendingCount + '</div>' +
                        '</div>' +
                        '<div class="stat-card">' +
                            '<h3>Pending Withdrawals</h3>' +
                            '<div class="value">' + pendingWithdrawalsCount + '</div>' +
                        '</div>' +
                        '<div class="stat-card">' +
                            '<h3>Total Credits</h3>' +
                            '<div class="value">' + totalCredits + '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div class="pending-donations">' +
                        '<h2>' +
                            'Pending Donations' +
                            '<button class="refresh-btn" onclick="loadPendingDonations()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div id="pending-donations-list">' +
                            renderDonationList(pendingDonations) +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading dashboard: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        async function loadPendingDonations() {
            showLoading();
            
            try {
                const donations = await apiRequest('/donations/status/pending');
                document.getElementById('main-content').innerHTML = 
                    '<div class="pending-donations">' +
                        '<h2>' +
                            'Pending Donations' +
                            '<button class="refresh-btn" onclick="loadPendingDonations()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div id="pending-donations-list">' +
                            (donations.length > 0 ? renderDonationList(donations) : 
                                '<div class="empty-state">' +
                                    '<p>No pending donations</p>' +
                                '</div>') +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading pending donations: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        async function loadApprovedDonations() {
            showLoading();
            
            try {
                const donations = await apiRequest('/donations/status/approved');
                document.getElementById('main-content').innerHTML = 
                    '<div class="pending-donations">' +
                        '<h2>' +
                            'Approved Donations' +
                            '<button class="refresh-btn" onclick="loadApprovedDonations()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div id="approved-donations-list">' +
                            (donations.length > 0 ? renderDonationList(donations) : 
                                '<div class="empty-state">' +
                                    '<p>No approved donations</p>' +
                                '</div>') +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading approved donations: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        async function loadRejectedDonations() {
            showLoading();
            
            try {
                const donations = await apiRequest('/donations/status/rejected');
                document.getElementById('main-content').innerHTML = 
                    '<div class="pending-donations">' +
                        '<h2>' +
                            'Rejected Donations' +
                            '<button class="refresh-btn" onclick="loadRejectedDonations()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div id="rejected-donations-list">' +
                            (donations.length > 0 ? renderDonationList(donations) : 
                                '<div class="empty-state">' +
                                    '<p>No rejected donations</p>' +
                                '</div>') +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading rejected donations: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        async function loadPendingWithdrawals() {
            showLoading();
            
            try {
                const withdrawals = await apiRequest('/withdrawals/status/pending');
                document.getElementById('main-content').innerHTML = 
                    '<div class="pending-donations">' +
                        '<h2>' +
                            'Pending Withdrawals' +
                            '<button class="refresh-btn" onclick="loadPendingWithdrawals()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div id="pending-withdrawals-list">' +
                            (withdrawals.length > 0 ? renderWithdrawalList(withdrawals) : 
                                '<div class="empty-state">' +
                                    '<p>No pending withdrawals</p>' +
                                '</div>') +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading pending withdrawals: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        async function loadUsers() {
            showLoading();
            
            try {
                const users = await apiRequest('/users');
                document.getElementById('main-content').innerHTML = 
                    '<div class="pending-donations">' +
                        '<h2>' +
                            'Users Management (' + users.length + ')' +
                            '<button class="refresh-btn" onclick="loadUsers()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div class="users-list">' +
                            (users.length > 0 ? renderUsersList(users) : 
                                '<div class="empty-state">' +
                                    '<p>No users found</p>' +
                                '</div>') +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading users: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        async function loadReports() {
            showLoading();
            
            try {
                // For now, we'll implement a placeholder
                // In a real implementation, you would generate reports
                document.getElementById('main-content').innerHTML = 
                    '<div class="pending-donations">' +
                        '<h2>' +
                            'Reports & Analytics' +
                            '<button class="refresh-btn" onclick="loadReports()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div class="empty-state">' +
                            '<p>Reports and analytics functionality will be implemented here.</p>' +
                            '<p>This section will show donation statistics, user engagement metrics, and financial reports.</p>' +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading reports: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        async function loadSettings() {
            showLoading();
            
            try {
                // Get current admin info
                const adminInfo = await apiRequest('/users/' + getCurrentUserId());
                
                document.getElementById('main-content').innerHTML = 
                    '<div class="pending-donations">' +
                        '<h2>' +
                            '<i class="fas fa-cog"></i> System Settings' +
                            '<button class="refresh-btn" onclick="loadSettings()">' +
                                '<i class="fas fa-sync-alt"></i> Refresh' +
                            '</button>' +
                        '</h2>' +
                        '<div class="settings-container">' +
                            '<div class="settings-card">' +
                                '<h3><i class="fas fa-lock"></i> Change Password</h3>' +
                                '<div class="form-group">' +
                                    '<label for="current-password">Current Password</label>' +
                                    '<input type="password" id="current-password" placeholder="Enter current password">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label for="new-password">New Password</label>' +
                                    '<input type="password" id="new-password" placeholder="Enter new password">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label for="confirm-password">Confirm New Password</label>' +
                                    '<input type="password" id="confirm-password" placeholder="Confirm new password">' +
                                '</div>' +
                                '<button class="btn btn-primary" onclick="changePassword()">Update Password</button>' +
                                '<div id="password-error" class="error-message"></div>' +
                            '</div>' +
                            
                            '<div class="settings-card">' +
                                '<h3><i class="fas fa-user"></i> Admin Information</h3>' +
                                '<div class="user-detail-row">' +
                                    '<label>Name:</label>' +
                                    '<span>' + (adminInfo.name || '') + '</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Email:</label>' +
                                    '<span>' + (adminInfo.email || '') + '</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Phone:</label>' +
                                    '<span>' + (adminInfo.phone || '') + '</span>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            } catch (error) {
                document.getElementById('main-content').innerHTML = 
                    '<div class="empty-state">' +
                        '<p>Error loading settings: ' + error.message + '</p>' +
                    '</div>';
            }
        }
        
        // Helper function to get current user ID from token
        function getCurrentUserId() {
            if (!authToken) return null;
            
            try {
                const payload = JSON.parse(atob(authToken.split('.')[1]));
                return payload.id;
            } catch (error) {
                return null;
            }
        }
        
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('password-error');
            
            // Reset error message
            errorDiv.textContent = '';
            
            // Validate input
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                return;
            }
            
            if (newPassword.length < 6) {
                errorDiv.textContent = 'New password must be at least 6 characters long';
                return;
            }
            
            try {
                await apiRequest('/settings/change-password', {
                    method: 'PUT',
                    body: JSON.stringify({ currentPassword, newPassword }),
                });
                
                // Clear form
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                
                showToast('Password changed successfully!', 'success');
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }
        
        function renderDonationList(donations) {
            if (donations.length === 0) {
                return 
                    '<div class="empty-state">' +
                        '<p>No donations found</p>' +
                    '</div>';
            }
            
            return donations.map(donation => 
                '<div class="donation-item" data-id="' + donation.id + '">' +
                    '<div class="donation-photo">' +
                        'Donation<br/>Photo' +
                    '</div>' +
                    '<div class="donation-details">' +
                        '<h3>' + (donation.title || '') + '</h3>' +
                        '<div class="donation-meta">' +
                            '<span>User: ' + (donation.user?.name || 'Unknown') + '</span>' +
                            '<span>Date: ' + (donation.date || '') + '</span>' +
                            '<span>Location: ' + (donation.location || '') + '</span>' +
                        '</div>' +
                        '<p>' + (donation.description || '') + '</p>' +
                        '<span class="status-badge status-' + donation.status + '">' + donation.status + '</span>' +
                        '<div class="donation-actions">' +
                            (donation.status === 'pending' ? 
                                '<button class="btn-action btn-approve" onclick="approveDonation(\'' + donation.id + '\')">Approve</button>' +
                                '<button class="btn-action btn-reject" onclick="rejectDonation(\'' + donation.id + '\')">Reject</button>' : '') +
                            '<button class="btn-action btn-view" onclick="viewDonationDetails(\'' + donation.id + '\')">View Details</button>' +
                        '</div>' +
                    '</div>' +
                '</div>'
            ).join('');
        }
        
        function renderWithdrawalList(withdrawals) {
            if (withdrawals.length === 0) {
                return 
                    '<div class="empty-state">' +
                        '<p>No withdrawals found</p>' +
                    '</div>';
            }
            
            return withdrawals.map(withdrawal => 
                '<div class="donation-item" data-id="' + withdrawal.id + '">' +
                    '<div class="donation-details">' +
                        '<h3>Withdrawal Request</h3>' +
                        '<div class="donation-meta">' +
                            '<span>User: ' + (withdrawal.user?.name || 'Unknown') + '</span>' +
                            '<span>Date: ' + (withdrawal.date || '') + '</span>' +
                            '<span>Amount: ' + (withdrawal.amount || 0) + ' credits</span>' +
                        '</div>' +
                        '<span class="status-badge status-' + withdrawal.status + '">' + withdrawal.status + '</span>' +
                        '<div class="donation-actions">' +
                            (withdrawal.status === 'pending' ? 
                                '<button class="btn-action btn-approve" onclick="processWithdrawal(\'' + withdrawal.id + '\')">Process</button>' +
                                '<button class="btn-action btn-reject" onclick="rejectWithdrawal(\'' + withdrawal.id + '\')">Reject</button>' : '') +
                        '</div>' +
                    '</div>' +
                '</div>'
            ).join('');
        }
        
        function renderUsersList(users) {
            if (users.length === 0) {
                return 
                    '<div class="empty-state">' +
                        '<p>No users found</p>' +
                    '</div>';
            }
            
            return 
                '<div class="users-table-container">' +
                    '<table class="users-table">' +
                        '<thead>' +
                            '<tr>' +
                                '<th>Name</th>' +
                                '<th>Email</th>' +
                                '<th>Phone</th>' +
                                '<th>Total Donations</th>' +
                                '<th>Total Credits</th>' +
                                '<th>Actions</th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                            users.map(user => 
                                '<tr>' +
                                    '<td>' + (user.name || '') + '</td>' +
                                    '<td>' + (user.email || '') + '</td>' +
                                    '<td>' + (user.phone || '') + '</td>' +
                                    '<td>' + (user.totalDonations || 0) + '</td>' +
                                    '<td>' + (user.totalCredits || 0) + ' credits</td>' +
                                    '<td>' +
                                        '<button class="btn-action btn-view" onclick="viewUserDetails(\'' + user.id + '\')">View</button>' +
                                    '</td>' +
                                '</tr>'
                            ).join('') +
                        '</tbody>' +
                    '</table>' +
                '</div>';
        }
        
        async function approveDonation(donationId) {
            if (confirm('Are you sure you want to approve this donation?')) {
                try {
                    await apiRequest('/donations/' + donationId + '/status', {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'approved' }),
                    });
                    
                    refreshCurrentView();
                    showToast('Donation approved successfully!', 'success');
                } catch (error) {
                    showToast('Error approving donation: ' + error.message, 'error');
                }
            }
        }
        
        async function rejectDonation(donationId) {
            if (confirm('Are you sure you want to reject this donation?')) {
                const reason = prompt('Please provide a reason for rejection:');
                if (reason) {
                    try {
                        await apiRequest('/donations/' + donationId + '/status', {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'rejected' }),
                        });
                        
                        refreshCurrentView();
                        showToast('Donation rejected successfully!', 'success');
                    } catch (error) {
                        showToast('Error rejecting donation: ' + error.message, 'error');
                    }
                }
            }
        }
        
        async function processWithdrawal(withdrawalId) {
            if (confirm('Are you sure you want to process this withdrawal?')) {
                try {
                    await apiRequest('/withdrawals/' + withdrawalId + '/status', {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'processed' }),
                    });
                    
                    refreshCurrentView();
                    showToast('Withdrawal processed successfully!', 'success');
                } catch (error) {
                    showToast('Error processing withdrawal: ' + error.message, 'error');
                }
            }
        }
        
        async function rejectWithdrawal(withdrawalId) {
            if (confirm('Are you sure you want to reject this withdrawal?')) {
                const reason = prompt('Please provide a reason for rejection:');
                if (reason) {
                    try {
                        await apiRequest('/withdrawals/' + withdrawalId + '/status', {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'rejected' }),
                        });
                        
                        refreshCurrentView();
                        showToast('Withdrawal rejected successfully!', 'success');
                    } catch (error) {
                        showToast('Error rejecting withdrawal: ' + error.message, 'error');
                    }
                }
            }
        }
        
        function viewDonationDetails(donationId) {
            // Redirect to donation details page
            window.location.href = '/admin/donation-details.html?id=' + donationId;
        }
        
        function viewUserDetails(userId) {
            // Show user details in a modal instead of alert
            showUserDetailsModal(userId);
        }
        
        async function showUserDetailsModal(userId) {
            try {
                const user = await apiRequest('/users/' + userId);
                
                // Create modal HTML
                const modalHTML = 
                    '<div class="modal-overlay" id="user-modal">' +
                        '<div class="modal-content">' +
                            '<div class="modal-header">' +
                                '<h2><i class="fas fa-user"></i> User Details</h2>' +
                                '<button class="modal-close" onclick="closeModal()">&times;</button>' +
                            '</div>' +
                            '<div class="modal-body">' +
                                '<div class="user-detail-row">' +
                                    '<label>Name:</label>' +
                                    '<span>' + (user.name || '') + '</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Email:</label>' +
                                    '<span>' + (user.email || '') + '</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Phone:</label>' +
                                    '<span>' + (user.phone || '') + '</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Total Donations:</label>' +
                                    '<span>' + (user.totalDonations || 0) + '</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Total Credits:</label>' +
                                    '<span>' + (user.totalCredits || 0) + ' credits</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Withdrawable Credits:</label>' +
                                    '<span>' + (user.withdrawableCredits || 0) + ' credits</span>' +
                                '</div>' +
                                '<div class="user-detail-row">' +
                                    '<label>Lifetime Credits:</label>' +
                                    '<span>' + (user.lifetimeCredits || 0) + ' credits</span>' +
                                '</div>' +
                                '<div class="modal-actions">' +
                                    '<button class="btn btn-reject" onclick="deleteUser(\'' + user.id + '\')">' +
                                        '<i class="fas fa-trash"></i> Delete User' +
                                    '</button>' +
                                    '<button class="btn btn-primary" onclick="closeModal()">' +
                                        '<i class="fas fa-times"></i> Close' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } catch (error) {
                alert('Error loading user details: ' + error.message);
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('user-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto'; // Re-enable scrolling
            }
        }
        
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    await apiRequest('/users/' + userId, {
                        method: 'DELETE',
                    });
                    
                    closeModal();
                    alert('User deleted successfully!');
                    refreshCurrentView(); // Refresh the current view to reflect changes
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        }
        
        function refreshData() {
            refreshCurrentView();
        }
        
        function refreshCurrentView() {
            const activeItem = document.querySelector('.sidebar li.active');
            if (activeItem) {
                const text = activeItem.textContent.trim();
                switch (text) {
                    case 'Dashboard':
                        loadDashboard();
                        break;
                    case 'Pending Donations':
                        loadPendingDonations();
                        break;
                    case 'Approved Donations':
                        loadApprovedDonations();
                        break;
                    case 'Rejected Donations':
                        loadRejectedDonations();
                        break;
                    case 'Pending Withdrawals':
                        loadPendingWithdrawals();
                        break;
                }
            }
        }
        
        // Toast notification function
        function showToast(message, type) {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast ' + (type || 'info');
            toast.textContent = message;
            toast.id = 'toast-notification';
            
            // Add to document
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>